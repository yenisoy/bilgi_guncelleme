<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deƒüi≈üiklikler - Bilgi Doƒürulama</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/admin.css?v=2">
</head>

<body>
    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <a href="dashboard.html" class="navbar-brand">
                <span>üìç Bilgi Doƒürulama</span>
            </a>
            <div class="navbar-nav">
                <a href="dashboard.html" class="nav-link">Ki≈üiler</a>
                <a href="import.html" class="nav-link">Excel Y√ºkle</a>
                <a href="changes.html" class="nav-link active">
                    Deƒüi≈üiklikler
                    <span id="pending-badge" class="nav-badge" style="display: none;">0</span>
                </a>
                <a href="definitions.html" class="nav-link">Tanƒ±mlamalar</a>
                <button onclick="logout()" class="btn btn-secondary-custom btn-sm ms-3">√áƒ±kƒ±≈ü</button>
            </div>
        </div>
    </nav>

    <main class="container page">
        <div class="page-header">
            <h2 class="page-title">Deƒüi≈üiklik Talepleri</h2>
            <div class="btn-group" role="group">
                <button onclick="setFilter('pending')" class="btn btn-outline-secondary active btn-sm"
                    data-filter="pending">Bekleyen</button>
                <button onclick="setFilter('approved')" class="btn btn-outline-secondary btn-sm"
                    data-filter="approved">Onaylanan</button>
                <button onclick="setFilter('rejected')" class="btn btn-outline-secondary btn-sm"
                    data-filter="rejected">Reddedilen</button>
                <button onclick="setFilter('all')" class="btn btn-outline-secondary btn-sm"
                    data-filter="all">T√ºm√º</button>
            </div>
        </div>

        <!-- Search -->
        <div class="d-flex gap-2 mb-4">
            <input type="text" id="search-input" class="form-control-custom" placeholder="ƒ∞sim veya il/il√ße ara..."
                style="max-width: 300px;">
        </div>

        <!-- Loading -->
        <div id="loading" class="loading">
            <div class="spinner"></div>
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="empty-state" style="display: none;">
            <div class="text-center py-5">
                <i class="fas fa-check-circle text-muted mb-3" style="font-size: 3rem;"></i>
                <p id="empty-message" class="text-muted h5">Bekleyen deƒüi≈üiklik talebi yok</p>
            </div>
        </div>

        <!-- Changes List -->
        <div id="changes-list"></div>
    </main>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <script src="../js/api.js"></script>
    <script>
        // Check auth
        if (!localStorage.getItem('token')) {
            window.location.href = 'login.html';
        }

        let currentFilter = 'pending';

        const fieldLabels = {
            firstName: 'ƒ∞sim',
            lastName: 'Soyisim',
            phone: 'Telefon',
            email: 'Email',
            province: 'ƒ∞l',
            district: 'ƒ∞l√ße',
            neighborhood: 'Mahalle',
            street: 'Sokak',
            buildingNo: 'Bina No',
            apartmentNo: 'Daire No',
            postalCode: 'Posta Kodu',
            fullAddress: 'Tam Adres'
        };

        // Load changes on page load
        loadChanges();

        function setFilter(filter) {
            currentFilter = filter;
            document.querySelectorAll('.btn-group .btn').forEach(btn => {
                const isActive = btn.dataset.filter === filter;
                btn.classList.toggle('active', isActive);
                btn.classList.toggle('btn-secondary', isActive);
                btn.classList.toggle('btn-outline-secondary', !isActive);
            });
            loadChanges();
        }

        async function loadChanges() {
            const loading = document.getElementById('loading');
            const emptyState = document.getElementById('empty-state');
            const changesList = document.getElementById('changes-list');
            const emptyMessage = document.getElementById('empty-message');

            loading.style.display = 'flex';
            emptyState.style.display = 'none';
            changesList.innerHTML = '';

            try {
                const response = await API.changes.getAll(currentFilter);
                loading.style.display = 'none';

                if (response.changes.length === 0) {
                    emptyMessage.textContent = currentFilter === 'pending'
                        ? 'Bekleyen deƒüi≈üiklik talebi yok'
                        : 'Bu kategoride deƒüi≈üiklik yok';
                    emptyState.style.display = 'block';
                    return;
                }

                changesList.innerHTML = response.changes.map(change => renderChange(change)).join('');
                updatePendingBadge();
            } catch (error) {
                loading.style.display = 'none';
                showToast('Deƒüi≈üiklikler y√ºklenirken hata olu≈ütu', 'error');
            }
        }

        function renderChange(change) {
            const statusBadge = {
                pending: '<span class="badge bg-warning text-dark">Bekliyor</span>',
                approved: '<span class="badge bg-success">Onaylandƒ±</span>',
                rejected: '<span class="badge bg-danger">Reddedildi</span>'
            };

            const date = new Date(change.createdAt).toLocaleString('tr-TR');
            const typeLabel = change.isNewEntry ? 'Yeni Kayƒ±t' : 'G√ºncelleme';

            let actionsHTML = '';
            if (change.status === 'pending') {
                actionsHTML = `
                    <div class="actions-footer">
                        <button onclick="approveChange('${change._id}')" class="btn btn-primary d-flex align-items-center gap-2">
                             <i class="fas fa-check"></i> Onayla
                        </button>
                        <button onclick="rejectChange('${change._id}')" class="btn btn-outline-danger d-flex align-items-center gap-2">
                             <i class="fas fa-times"></i> Reddet
                        </button>
                    </div>
                `;
            }

            // Generate Diff Rows
            // Generate Diff Rows
            const diffRows = Object.entries(fieldLabels).map(([key, label]) => {
                const newVal = change.newData[key] || '-';
                const oldVal = change.oldData ? (change.oldData[key] || '-') : '-';

                // Skip if both are empty/dash
                if (newVal === '-' && oldVal === '-') return '';

                const isChanged = change.oldData && String(newVal).trim() !== String(oldVal).trim();
                let rowClass = isChanged ? 'diff-row changed' : 'diff-row';

                // Special highlight for Manual Neighborhood
                let newValHTML = newVal;
                if (key === 'neighborhood' && change.newData.isManualNeighborhood) {
                    newValHTML = `
                        <span class="manual-neighborhood-value">${newVal}</span>
                        <span class="badge bg-info text-dark badge-manual-entry" style="margin-left:8px; font-size:0.75em;">
                            <i class="fas fa-pen"></i> Manuel Giri≈ü (Sistemde Yok)
                        </span>
                    `;
                    rowClass += ' table-warning'; // Slight yellow tint for the row
                }

                return `
                    <tr class="${rowClass}">
                        <td width="20%">${label}</td>
                        <td width="40%">${oldVal}</td>
                        <td width="40%">${newValHTML}</td>
                    </tr>
                `;
            }).join('');

            return `
                <div class="change-card">
                    <div class="change-header">
                        <div class="change-info">
                            <span class="change-title">${change.oldData?.firstName || 'Yeni'} ${change.oldData?.lastName || 'Ki≈üi'}</span>
                            <span class="change-date">
                                <span class="badge bg-light text-dark border me-2">${typeLabel}</span>
                                <i class="far fa-clock me-1"></i> ${date}
                            </span>
                        </div>
                        ${statusBadge[change.status]}
                    </div>
                    
                    <table class="diff-table">
                        <thead>
                            <tr>
                                <th>Alan</th>
                                <th>Eski Veri</th>
                                <th>Yeni Veri</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${diffRows}
                        </tbody>
                    </table>
                    
                    ${actionsHTML}
                </div>
            `;
        }

        async function approveChange(id) {
            // Find the change object to check if it's manual
            const changeCard = document.querySelector(`button[onclick="approveChange('${id}')"]`).closest('.change-card');
            const isManual = changeCard.querySelector('.badge-manual-entry') !== null;

            let addToSystem = false;

            if (isManual) {
                const neighborhoodName = changeCard.querySelector('.manual-neighborhood-value').textContent;
                if (confirm(`"${neighborhoodName}" mahallesi sistemde kayƒ±tlƒ± deƒüil.\n\nBu mahalleyi sisteme de eklemek ister misiniz?`)) {
                    addToSystem = true;
                }
            }

            try {
                await API.changes.approve(id, addToSystem);
                showToast(addToSystem ? 'Deƒüi≈üiklik onaylandƒ± ve mahalle sisteme eklendi' : 'Deƒüi≈üiklik onaylandƒ±', 'success');
                loadChanges();
            } catch (error) {
                showToast(error.message || 'Onaylama sƒ±rasƒ±nda hata olu≈ütu', 'error');
            }
        }

        async function rejectChange(id) {
            if (!confirm('Bu deƒüi≈üikliƒüi reddetmek istediƒüinize emin misiniz?')) return;

            try {
                await API.changes.reject(id);
                showToast('Deƒüi≈üiklik reddedildi', 'success');
                loadChanges();
            } catch (error) {
                showToast(error.message || 'Reddetme sƒ±rasƒ±nda hata olu≈ütu', 'error');
            }
        }


        async function updatePendingBadge() {
            try {
                const response = await API.changes.getPendingCount();
                const badge = document.getElementById('pending-badge');
                if (response.count > 0) {
                    badge.textContent = response.count;
                    badge.style.display = 'inline-flex';
                } else {
                    badge.style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading pending count:', error);
            }
        }

        function logout() {
            localStorage.removeItem('token');
            window.location.href = 'login.html';
        }
    </script>
</body>

</html>